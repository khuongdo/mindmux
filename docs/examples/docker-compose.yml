version: '3.8'

services:
  mindmux:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: mindmux-dev
    image: mindmux:latest

    # Keep container running
    command: tail -f /dev/null

    # Volumes for code and config
    volumes:
      # Current source code
      - ../../:/app

      # Persistent configuration
      - mindmux-config:/root/.mindmux

      # Shared logs
      - ./logs:/root/.mindmux/logs

    # Environment variables
    environment:
      - NODE_ENV=development
      - MINDMUX_LOGGING_LEVEL=debug
      - MINDMUX_DEFAULT_AGENT_TYPE=claude

      # API keys - set these or use .env file
      # - MINDMUX_CLAUDE_API_KEY=${MINDMUX_CLAUDE_API_KEY}
      # - MINDMUX_GEMINI_API_KEY=${MINDMUX_GEMINI_API_KEY}
      # - MINDMUX_GPT4_API_KEY=${MINDMUX_GPT4_API_KEY}

    # Load environment variables from file
    env_file:
      - .env

    # Interactive terminal
    stdin_open: true
    tty: true

    # Port mapping (for future API server)
    # ports:
    #   - "8080:8080"

    # Network
    networks:
      - mindmux

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

    # Health check
    healthcheck:
      test: ["CMD", "node", "dist/cli.js", "agent:list"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  mindmux-config:
    driver: local

networks:
  mindmux:
    driver: bridge

# Usage:
# 1. Build the image:
#    docker-compose build
#
# 2. Start the container:
#    docker-compose up -d
#
# 3. Run commands inside:
#    docker-compose exec mindmux mux agent:list
#
# 4. View logs:
#    docker-compose logs -f mindmux
#
# 5. Stop container:
#    docker-compose down
#
# Set API keys:
# 1. Create .env file in this directory:
#    MINDMUX_CLAUDE_API_KEY=sk-ant-...
#    MINDMUX_GEMINI_API_KEY=AIza...
#    MINDMUX_GPT4_API_KEY=sk-...
#
# 2. Uncomment env_file section above
#
# 3. Restart container:
#    docker-compose down
#    docker-compose up -d
